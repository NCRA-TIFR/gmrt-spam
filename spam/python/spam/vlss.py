###############################################################################

# import Python modules
from sys import *
from math import *

# import 3rd party modules
from numpy import *

# import user modules
from spam import *

###############################################################################

field_names = [
    '0000-041',
    '0000+041',
    '0000-123',
    '0000+123',
    '0000-208',
    '0000+208',
    '0000-298',
    '0000+298',
    '0000+398',
    '0000+517',
    '0000+639',
    '0000+758',
    '0030+000',
    '0030-082',
    '0030+082',
    '0030-166',
    '0030+166',
    '0030+253',
    '0030+346',
    '0030+453',
    '0030+588',
    '0100-041',
    '0100+041',
    '0100-123',
    '0100+123',
    '0100-208',
    '0100+208',
    '0100-298',
    '0100+298',
    '0100+398',
    '0100+517',
    '0100+690',
    '0130+000',
    '0130-082',
    '0130+082',
    '0130-166',
    '0130+166',
    '0130-253',
    '0130+253',
    '0130+346',
    '0130+453',
    '0130+588',
    '0200-041',
    '0200+041',
    '0200-123',
    '0200+123',
    '0200-208',
    '0200+208',
    '0200-298',
    '0200+298',
    '0200+398',
    '0200+517',
    '0200+639',
    '0200+726',
    '0200+815',
    '0230+000',
    '0230-082',
    '0230+082',
    '0230-166',
    '0230+166',
    '0230-253',
    '0230+253',
    '0230+346',
    '0230+453',
    '0230+588',
    '0300-041',
    '0300+041',
    '0300-123',
    '0300+123',
    '0300-208',
    '0300+208',
    '0300-298',
    '0300+298',
    '0300+398',
    '0300+517',
    '0300+690',
    '0330+000',
    '0330-082',
    '0330+082',
    '0330-166',
    '0330+166',
    '0330-253',
    '0330+253',
    '0330+346',
    '0330+453',
    '0330+588',
    '0400-041',
    '0400+041',
    '0400-123',
    '0400+123',
    '0400-208',
    '0400+208',
    '0400-298',
    '0400+298',
    '0400+398',
    '0400+517',
    '0400+639',
    '0400+758',
    '0430+000',
    '0430-082',
    '0430+082',
    '0430-166',
    '0430+166',
    '0430-253',
    '0430+253',
    '0430+346',
    '0430+453',
    '0430+588',
    '0500-041',
    '0500+041',
    '0500-123',
    '0500+123',
    '0500-208',
    '0500+208',
    '0500-298',
    '0500+298',
    '0500+398',
    '0500+517',
    '0500+690',
    '0530+000',
    '0530-082',
    '0530+082',
    '0530-166',
    '0530+166',
    '0530-253',
    '0530+253',
    '0530+346',
    '0530+453',
    '0530+588',
    '0600-041',
    '0600+041',
    '0600-123',
    '0600+123',
    '0600-208',
    '0600+208',
    '0600-298',
    '0600+298',
    '0600+398',
    '0600+517',
    '0600+639',
    '0600+726',
    '0600+815',
    '0630+000',
    '0630-082',
    '0630+082',
    '0630-166',
    '0630+166',
    '0630-253',
    '0630+253',
    '0630+346',
    '0630+453',
    '0630+588',
    '0700-041',
    '0700+041',
    '0700-123',
    '0700+123',
    '0700-208',
    '0700+208',
    '0700-298',
    '0700+298',
    '0700+398',
    '0700+517',
    '0700+690',
    '0730+000',
    '0730-082',
    '0730+082',
    '0730-166',
    '0730+166',
    '0730-253',
    '0730+253',
    '0730+346',
    '0730+453',
    '0730+588',
    '0800-041',
    '0800+041',
    '0800-123',
    '0800+123',
    '0800-208',
    '0800+208',
    '0800-298',
    '0800+298',
    '0800+398',
    '0800+517',
    '0800+639',
    '0800+758',
    '0830+000',
    '0830-082',
    '0830+082',
    '0830-166',
    '0830+166',
    '0830-253',
    '0830+253',
    '0830+346',
    '0830+453',
    '0830+588',
    '0900-041',
    '0900+041',
    '0900-123',
    '0900+123',
    '0900-208',
    '0900+208',
    '0900-298',
    '0900+298',
    '0900+398',
    '0900+517',
    '0900+690',
    '0930+000',
    '0930+082',
    '0930+166',
    '0930-253',
    '0930+253',
    '0930+346',
    '0930+453',
    '0930+588',
    '1000-041',
    '1000+041',
    '1000-123',
    '1000+123',
    '1000-208',
    '1000+208',
    '1000-298',
    '1000+298',
    '1000+398',
    '1000+517',
    '1000+639',
    '1000+726',
    '1000+815',
    '1030+000',
    '1030-082',
    '1030+082',
    '1030-166',
    '1030+166',
    '1030-253',
    '1030+253',
    '1030+346',
    '1030+453',
    '1030+588',
    '1100-041',
    '1100+041',
    '1100-123',
    '1100+123',
    '1100-208',
    '1100+208',
    '1100-298',
    '1100+298',
    '1100+398',
    '1100+517',
    '1100+690',
    '1130+000',
    '1130-082',
    '1130+082',
    '1130-166',
    '1130+166',
    '1130-253',
    '1130+253',
    '1130+346',
    '1130+453',
    '1130+588',
    '1200-041',
    '1200+041',
    '1200-123',
    '1200+123',
    '1200-208',
    '1200+208',
    '1200-298',
    '1200+298',
    '1200+398',
    '1200+517',
    '1200+639',
    '1200+758',
    '1230+000',
    '1230-082',
    '1230-166',
    '1230-253',
    '1230+253',
    '1230+346',
    '1230+453',
    '1230+588',
    '1300-041',
    '1300+041',
    '1300-123',
    '1300+123',
    '1300-208',
    '1300+208',
    '1300-298',
    '1300+298',
    '1300+398',
    '1300+517',
    '1300+690',
    '1330+000',
    '1330-082',
    '1330+082',
    '1330-166',
    '1330+166',
    '1330-253',
    '1330+253',
    '1330+346',
    '1330+453',
    '1330+588',
    '1400-041',
    '1400+041',
    '1400-123',
    '1400+123',
    '1400-208',
    '1400+208',
    '1400-298',
    '1400+298',
    '1400+398',
    '1400+517',
    '1400+639',
    '1400+726',
    '1400+815',
    '1430+000',
    '1430-082',
    '1430+082',
    '1430-166',
    '1430+166',
    '1430-253',
    '1430+253',
    '1430+346',
    '1430+453',
    '1430+588',
    '1500-041',
    '1500+041',
    '1500-123',
    '1500+123',
    '1500-208',
    '1500+208',
    '1500-298',
    '1500+298',
    '1500+398',
    '1500+517',
    '1500+690',
    '1530+000',
    '1530-082',
    '1530+082',
    '1530-166',
    '1530+166',
    '1530-253',
    '1530+253',
    '1530+346',
    '1530+453',
    '1530+588',
    '1600-041',
    '1600+041',
    '1600-123',
    '1600+123',
    '1600-208',
    '1600+208',
    '1600-298',
    '1600+298',
    '1600+398',
    '1600+517',
    '1600+639',
    '1600+758',
    '1630+000',
    '1630-082',
    '1630-166',
    '1630+166',
    '1630-253',
    '1630+253',
    '1630+346',
    '1630+453',
    '1630+588',
    '1700-123',
    '1700-208',
    '1700+208',
    '1700-298',
    '1700+298',
    '1700+398',
    '1700+517',
    '1700+690',
    '1730-082',
    '1730+082',
    '1730-166',
    '1730+166',
    '1730-253',
    '1730+253',
    '1730+346',
    '1730+453',
    '1730+588',
    '1800-041',
    '1800+041',
    '1800-123',
    '1800+123',
    '1800-208',
    '1800+208',
    '1800+298',
    '1800+398',
    '1800+517',
    '1800+639',
    '1800+726',
    '1800+815',
    '1830+000',
    '1830-082',
    '1830+082',
    '1830-166',
    '1830+166',
    '1830-253',
    '1830+253',
    '1830+346',
    '1830+453',
    '1830+588',
    '1900-041',
    '1900+041',
    '1900-123',
    '1900+123',
    '1900-208',
    '1900+208',
    '1900-298',
    '1900+298',
    '1900+398',
    '1900+517',
    '1900+690',
    '1930+000',
    '1930-082',
    '1930+082',
    '1930-166',
    '1930+166',
    '1930-253',
    '1930+253',
    '1930+346',
    '1930+588',
    '2000-041',
    '2000+041',
    '2000-123',
    '2000+123',
    '2000-208',
    '2000+208',
    '2000-298',
    '2000+639',
    '2000+758',
    '2030+000',
    '2030-082',
    '2030+082',
    '2030-166',
    '2030+166',
    '2030-253',
    '2030+253',
    '2030+588',
    '2100-041',
    '2100+041',
    '2100-123',
    '2100+123',
    '2100-208',
    '2100+208',
    '2100-298',
    '2100+298',
    '2100+517',
    '2100+690',
    '2130+000',
    '2130-082',
    '2130+082',
    '2130-166',
    '2130+166',
    '2130-253',
    '2130+253',
    '2130+346',
    '2130+453',
    '2130+588',
    '2200-041',
    '2200+041',
    '2200-123',
    '2200+123',
    '2200-208',
    '2200+208',
    '2200-298',
    '2200+298',
    '2200+398',
    '2200+517',
    '2200+639',
    '2200+726',
    '2200+815',
    '2230+000',
    '2230-082',
    '2230+082',
    '2230-166',
    '2230+166',
    '2230-253',
    '2230+253',
    '2230+346',
    '2230+453',
    '2230+588',
    '2300-041',
    '2300+041',
    '2300-123',
    '2300+123',
    '2300-208',
    '2300+208',
    '2300-298',
    '2300+298',
    '2330-166',
    '2330-253' ]

###############################################################################

def parse_vlss( fits_path, postfix = '.I.fits', fields = [] ):
  skipped_fields = []
  if ( len( fields ) == 0 ):
    fns = field_names
  else:
    fns = fields
  for fn in fns:
    fits_file_name = fits_path + '/' + fn + postfix
    if ( not file_exists( fits_file_name ) ):
      print ''
      print 'SKIPPING field %s' % ( fn )
      print ''
      skipped_fields.append( fn )
    else:
#      run_bdsm( fits_file_name )
#      if ( ret != 0 ):
      if True:
        new_fits_file_name = 'fits/' + fn + postfix
        vlss_image = get_aips_file( 1, fn, 'I', -1, 'MA' )
        read_fits_image( fits_file_name, vlss_image )
        fill_facet( vlss_image, do_edge_circle = True )
        write_fits_image( vlss_image, new_fits_file_name )
        vlss_image.zap()
        ret = run_bdsm( new_fits_file_name )
        remove_file( new_fits_file_name )
        if ( ret != 0 ):
          print ''
          print 'SKIPPING field %s' % ( fn )
          print ''
          skipped_fields.append( fn )
  return skipped_fields

###############################################################################

def read_bstat_file( bstat_file_name ):
  if ( not file_exists( bstat_file_name ) ):
    raise error( 'BSTAT file %s does not exist' % ( bstat_file_name ) )
  bstats = {}
  bstat_file = file( bstat_file_name, mode = 'r' )
  for line in bstat_file:
    words = line.split()
    if ( words[ 1 ] != '=' ):
      continue
    key = words[ 0 ]
    if ( '.' in words[ 2 ] ):
      try:
        value = float( words[ 2 ] )
      except:
        value = words[ 2 ]
    else:
      try:
        value = int( words[ 2 ] )
      except:
        value = words[ 2 ]
    bstats[ key ] = value
  return bstats

###############################################################################

def read_vlss_extraction_summary( postfix = '.I.def.' ):
  summary = [ [ 'field', 'rms' ] ]
  for fn in field_names:
    bstat_file_name = fn + postfix + 'bstat'
    srl_file_name = fn + postfix + 'srl'
    if ( ( not file_exists( bstat_file_name ) ) or 
        ( not file_exists( srl_file_name ) ) ):
      print ''
      print 'SKIPPING field %s' % ( fn )
      print ''
    else:
      bstats = read_bstat_file( bstat_file_name )
      srl = read_bdsm_source_catalog( srl_file_name )
      summary.append( [ fn, bstats[ 'rms' ], len( srl ) - 1 ] )
  return summary

###############################################################################
